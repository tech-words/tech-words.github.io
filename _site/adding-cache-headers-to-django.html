<!doctype html>

<!--
## Features:

- Keep CSS inline: It will be small enough not to add much weight to the page, which means it's better to avoid the extra HTTP call to request CSS
- Use system fonts: But it's hard to find a nice system font for both Linux, Windows and MacOS

- Google colours for links
- Visual box around article to highlight it
- Navigation - don't get in the way
- 

JavaScript:

- Only use enhancements that aren't necessary:
  - Document outline on the left
  - Add "title" to links

-->

<html lang="en">

<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Django HTTP headers: Controlling caching on cn.ubuntu.com</title>

  <meta name="description" content="As optimising web performance becomes more and more important, it's becoming essential to carefully manage your caching headers. But Django doesn't make it hat easy.">

  <!-- Social media -->
  <meta property='article:author' content='https://twitter.com/nottrobin' />
  <meta property='article:publisher' content='https://robinwinslow.uk' />
  <meta property="og:image" content="https://www.thebluediamondgallery.com/tablet/images/blog.jpg" />
  <meta property="og:url" content="https://robinwinslow.uk/adding-cache-headers-to-django" />
  <meta property="og:type" content="article" />
  <meta property="og:title" content="Django HTTP headers: Controlling caching on cn.ubuntu.com" />
  <!-- Keep Terry Pratchett alive in the network https://xclacksoverhead.org/home/about -->
  <meta http-equiv="x-clacks-overhead" content="GNU Terry Pratchett" />

  <link type="application/atom+xml" rel="alternative" href="/rss.xml" />

  <style>
    /**
       * Font size
       * 
       * For usability, bigger text is almost always better. People continue to Especially as resolutions get higher
       * 
       */

    body {
      font-family: "dejavu Sans light", sans-serif;
      font-size: 1.5rem;
      background-color: #efefef;
      margin: 0;
    }

    time,
    .subtitle {
      color: #767676;
    }

    h1,
    h2,
    h3,
    h4 {
      font-weight: normal;
      margin-top: 2em;
      margin-bottom: 1em;
    }

    h1 {
      font-size: 2em;
    }

    h2 {
      font-size: 1.5em;
    }

    h3 {
      font-size: 1.2em;
    }

    h4 {
      font-size: 1.1em;
    }

    p {
      line-height: 1.5em;
    }

    a {
      color: #1a0dab;
      text-decoration: none;
    }

    a:hover {
      text-decoration: underline;
    }

    a:visited {
      color: #551A8B;
    }

    input,
    button {
      appearance: none;
      border: 1px solid lightgray;
      font-size: 1em;
      max-width: 100%;
      padding: 0.5em 0.8em;
    }

    article {
      margin: auto;
      padding: 3em 5em;
      max-width: 35em;
      background-color: white;
    }

    @media (max-width: 1080px) {
      article {
        padding: 0.5em 1.5em;
      }
    }

    article p,
    article ul,
    article ol {
      margin-block-start: 1.5em;
      margin-block-end: 1.5em;
    }

    article li {
      margin-block-start: 1em;
      margin-block-end: 1em;
      line-height: 1.5em;
    }

    blockquote {
      padding: 1em 1.5em;
      margin: 1.5em 0;
      border-left: 2px solid #ddd;
      font-style: italic;
    }

    blockquote p {
      display: inline;
    }

    pre {
      overflow-x: auto;
      background-color: #eee;
      padding: 1em;
      line-height: 125%;
    }

    img {
      max-width: 100%;
    }

    code {
      padding: 0.125em 0.25em;
      line-height: 1.6em;
      margin: 0;
      font-size: 0.8em;
      background-color: #f0f0f0;
      border-radius: 6px;
    }

    pre code {
      line-height: inherit;
      padding: 0;
    }

    hr {
      margin: 3em 0;
    }

    /* Classes */
    .article-header {
      margin: auto;
      max-width: 60em;
      padding: 3em 1em;
      text-align: center;
    }

    .article-header h1 {
      font-size: 3em;
      margin: 0 0 0.5em 0;
    }

    @media (max-width: 1080px) {
      .article-header h1 {
        font-size: 2.3em;
      }
    }

    .back-to-home {
      padding: 0 1.5em;
    }

    .title {
      text-align: center;
      margin: 1em 1em 2em 1em;
    }

    .title h1 {
      margin-bottom: 0;
    }

    .title p {
      margin-top: 0.25em;
    }

    .search-form {
      text-align: center;
      margin: 0.8em 1em;
    }

    .search-form input,
    .search-form button {
      margin: 0.2em 0;
    }

    .posts li {
      margin: 3em 0;
    }

    .posts li article {
      padding: 0.5em 3em;
    }

    .posts li article .date {
      margin-top: 0.5em;
      font-size: 0.8em;
    }

    @media (max-width: 984px) {
      .posts li article {
        padding: 1.5em;
      }
    }

    .posts li article h1 {
      font-size: 1.5em;
      margin: 1em 0 0 0;
      font-weight: normal;
    }

    @media (max-width: 984px) {
      .posts li article h1 {
        font-size: 1.3em;
      }
    }

    .posts {
      padding: 0;
      margin: 0;
      list-style-type: none;
    }

    .see-the-code {
      padding: 1.5em;
      font-size: 0.8em;
      text-align: right;
    }

    .discuss {
      text-align: center;
      font-style: italic;
    }

    .author {
      text-align: center;
      margin: 3em;
      font-style: normal;
    }

    .more-posts {
      padding: 1.5em 3em;
      margin: auto;
      background-color: white;
      max-width: 35em;
    }

    .more-posts h2 {
      margin-top: 1em;
    }

    .more-posts time {
      font-size: 0.8em;
    }

    .headings {
      position: absolute;
      text-align: right;
      font-size: 0.8em;
      opacity: 0.5;
      position: fixed;
      display: none;
    }

    .headings ol {
      margin: 6em 6em 1.5em 1.5em;
      padding: 0;
    }

    .headings ol li {
      list-style-type: none;
      margin: 1.5em 0 0 0;
    }

    .headings ol li.h2 {
      font-size: 0.8em;
      opacity: 0.8;
      margin: 0.7em 0 0 0;
    }

    .heading-link {
      opacity: 0.4;
      font-size: 2rem;
    }

    table {
      border-spacing: 0;
      font-size: 0.8em;
    }

    td {
      padding: 1em;
      border-left: 1px dotted #666;
      border-top: 1px dotted #666;
    }

    td:last-child {
      border-right: 1px dotted #666;
    }

    tr:last-child td {
      border-bottom: 1px dotted #666;
    }

    /* Pygments syntax highlighting autumn theme */
    td.linenos pre {
      color: #000000;
      background-color: #f0f0f0;
      padding-left: 5px;
      padding-right: 5px;
    }

    span.linenos {
      color: #000000;
      background-color: #f0f0f0;
      padding-left: 5px;
      padding-right: 5px;
    }

    td.linenos pre.special {
      color: #000000;
      background-color: #ffffc0;
      padding-left: 5px;
      padding-right: 5px;
    }

    span.linenos.special {
      color: #000000;
      background-color: #ffffc0;
      padding-left: 5px;
      padding-right: 5px;
    }

    .highlight .hll {
      background-color: #ffffcc
    }

    .highlight {
      background: #f0f0f0;
    }

    .highlight .c {
      color: #60a0b0;
      font-style: italic
    }

    .highlight .err {
      border: 1px solid #FF0000
    }

    .highlight .k {
      color: #007020;
      font-weight: bold
    }

    .highlight .o {
      color: #666666
    }

    .highlight .ch {
      color: #60a0b0;
      font-style: italic
    }

    .highlight .cm {
      color: #60a0b0;
      font-style: italic
    }

    .highlight .cp {
      color: #007020
    }

    .highlight .cpf {
      color: #60a0b0;
      font-style: italic
    }

    .highlight .c1 {
      color: #60a0b0;
      font-style: italic
    }

    .highlight .cs {
      color: #60a0b0;
      background-color: #fff0f0
    }

    .highlight .gd {
      color: #A00000
    }

    .highlight .ge {
      font-style: italic
    }

    .highlight .gr {
      color: #FF0000
    }

    .highlight .gh {
      color: #000080;
      font-weight: bold
    }

    .highlight .gi {
      color: #00A000
    }

    .highlight .go {
      color: #888888
    }

    .highlight .gp {
      color: #c65d09;
      font-weight: bold
    }

    .highlight .gs {
      font-weight: bold
    }

    .highlight .gu {
      color: #800080;
      font-weight: bold
    }

    .highlight .gt {
      color: #0044DD
    }

    .highlight .kc {
      color: #007020;
      font-weight: bold
    }

    .highlight .kd {
      color: #007020;
      font-weight: bold
    }

    .highlight .kn {
      color: #007020;
      font-weight: bold
    }

    .highlight .kp {
      color: #007020
    }

    .highlight .kr {
      color: #007020;
      font-weight: bold
    }

    .highlight .kt {
      color: #902000
    }

    .highlight .m {
      color: #40a070
    }

    .highlight .s {
      color: #4070a0
    }

    .highlight .na {
      color: #4070a0
    }

    .highlight .nb {
      color: #007020
    }

    .highlight .nc {
      color: #0e84b5;
      font-weight: bold
    }

    .highlight .no {
      color: #60add5
    }

    .highlight .nd {
      color: #555555;
      font-weight: bold
    }

    .highlight .ni {
      color: #d55537;
      font-weight: bold
    }

    .highlight .ne {
      color: #007020
    }

    .highlight .nf {
      color: #06287e
    }

    .highlight .nl {
      color: #002070;
      font-weight: bold
    }

    .highlight .nn {
      color: #0e84b5;
      font-weight: bold
    }

    .highlight .nt {
      color: #062873;
      font-weight: bold
    }

    .highlight .nv {
      color: #bb60d5
    }

    .highlight .ow {
      color: #007020;
      font-weight: bold
    }

    .highlight .w {
      color: #bbbbbb
    }

    .highlight .mb {
      color: #40a070
    }

    .highlight .mf {
      color: #40a070
    }

    .highlight .mh {
      color: #40a070
    }

    .highlight .mi {
      color: #40a070
    }

    .highlight .mo {
      color: #40a070
    }

    .highlight .sa {
      color: #4070a0
    }

    .highlight .sb {
      color: #4070a0
    }

    .highlight .sc {
      color: #4070a0
    }

    .highlight .dl {
      color: #4070a0
    }

    .highlight .sd {
      color: #4070a0;
      font-style: italic
    }

    .highlight .s2 {
      color: #4070a0
    }

    .highlight .se {
      color: #4070a0;
      font-weight: bold
    }

    .highlight .sh {
      color: #4070a0
    }

    .highlight .si {
      color: #70a0d0;
      font-style: italic
    }

    .highlight .sx {
      color: #c65d09
    }

    .highlight .sr {
      color: #235388
    }

    .highlight .s1 {
      color: #4070a0
    }

    .highlight .ss {
      color: #517918
    }

    .highlight .bp {
      color: #007020
    }

    .highlight .fm {
      color: #06287e
    }

    .highlight .vc {
      color: #bb60d5
    }

    .highlight .vg {
      color: #bb60d5
    }

    .highlight .vi {
      color: #bb60d5
    }

    .highlight .vm {
      color: #bb60d5
    }

    .highlight .il {
      color: #40a070
    }
  </style>
</head>

<body>
  <nav class="back-to-home">
  <p><a href="/">← Posts</a></h1></p>
</nav>

<header class="article-header">
  <h1>Django HTTP headers: Controlling caching on cn.ubuntu.com</h1>
  <time datetime="2016-02-24">24th February 2016</time>
</header>

<nav class="headings">
  <ol>
    <li><a href="#top">↑ top</a></li>
  </ol>
</nav>

<article>
  <p><small>Also published <a href="http://design.canonical.com/">on design.canonical.com</a>.</small></p>

<p>It’s becoming <a href="https://developers.google.com/speed/docs/insights/LeverageBrowserCaching" title="PageSpeed Insights: Leverage Browser Caching">more and more important</a> for websites to carefully consider
how their <a href="https://devcenter.heroku.com/articles/increasing-application-performance-with-http-cache-headers" title="Heroku: Increasing Application Performance with HTTP Cache Headers">resources are cached</a> in users’ browsers. Get the caching wrong,
and you either end up with a woefully slow experience for the user, or a very
strange looking website as users are left with stale CSS files and images.</p>

<p>Or often both.</p>

<p>For our <a href="http://cn.ubuntu.com">China site</a>, we’ve decided that the HTML pages
should be cached for 5 minutes, and the CSS and JavaScript can be cached for a
year - as every time we update them we <a href="https://github.com/ubuntudesign/django-versioned-static-url" title="UbuntuDesign on GitHub: Django versioned static">change the URL</a>.</p>

<h2 id="caching-headers-in-django">Caching headers in Django</h2>

<p>Telling the browser how long to cache a resource is done with one of two headers:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">Cache-Control</code>: In HTTP/1.1, this can set the maximum age before a resource should be re-downloaded.</li>
  <li><code class="language-plaintext highlighter-rouge">Expires</code>: In the older HTTP/1.0 standard, this sets the date and time that a resource becomes outdated and should be refreshed.</li>
</ul>

<p>To control these headers in Django is less simple than you might think. If you’re
happy to use the <a href="https://docs.djangoproject.com/en/1.9/topics/cache/" title="Django’s cache framework">cache framework</a> then it will take care of these headers
for you, but as we have a separate <a href="http://www.squid-cache.org/" title="Squid: Optimising Web Delivery">Squid cache</a> in front of our application,
this was a more heavyweight solution than we needed.</p>

<h2 id="modifying-html-responses-using-view-classes">Modifying HTML responses using View classes</h2>

<p>In our case, all of our HTML pages are served with an extended version of
the <a href="https://docs.djangoproject.com/es/1.9/ref/class-based-views/base/#templateview" title="Django base views: TemplateView">TemplateView class</a>:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">django.views.generic.base</span> <span class="kn">import</span> <span class="n">TemplateView</span>

<span class="k">class</span> <span class="nc">OurTemplateView</span><span class="p">(</span><span class="n">TemplateView</span><span class="p">):</span>
    <span class="c1"># Setup our custom template data
</span></code></pre></div></div>

<p>To add headers, we need to modify the <a href="https://docs.djangoproject.com/en/1.9/ref/request-response/#httpresponse-objects" title="Django request and response objects: HttpResponse objects"><code class="language-plaintext highlighter-rouge">HTTPResponse</code></a>, which we can intercept
by extending the <code class="language-plaintext highlighter-rouge">render_to_response</code> method.</p>

<p>Django also provides <a href="https://docs.djangoproject.com/en/1.9/ref/utils/#django.utils.cache.patch_response_headers" title="Django Utils: django.utils.cache.patch_response_headers"><code class="language-plaintext highlighter-rouge">patch_response_headers</code></a> a handy helper function to generate our caching headers for us
and attach them to the response:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">OurTemplateView</span><span class="p">(</span><span class="n">TemplateView</span><span class="p">):</span>
  <span class="k">def</span> <span class="nf">render_to_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="o">**</span><span class="n">response_kwargs</span><span class="p">):</span>
      <span class="c1"># Get response from parent TemplateView class
</span>      <span class="n">response</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">CmsTemplateFinder</span><span class="p">,</span> <span class="bp">self</span><span class="p">).</span><span class="n">render_to_response</span><span class="p">(</span>
          <span class="n">context</span><span class="p">,</span> <span class="o">**</span><span class="n">response_kwargs</span>
      <span class="p">)</span>

      <span class="c1"># Add Cache-Control and Expires headers
</span>      <span class="n">patch_response_headers</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">cache_timeout</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>

      <span class="c1"># Return response
</span>      <span class="k">return</span> <span class="n">response</span>
</code></pre></div></div>

<p>And now we can see our extra caching headers in the HTTP response:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>curl <span class="nt">-I</span> cn.ubuntu.com
...
Date: Fri, 12 Feb 2016 22:48:38 GMT
Expires: Fri, 12 Feb 2016 22:53:35 GMT
Last-Modified: Fri, 12 Feb 2016 22:48:35 GMT
Cache-Control: max-age<span class="o">=</span>300
</code></pre></div></div>

<p>Browsers and proxies will now cache the HTML pages for 5 minutes.</p>

<h2 id="controlling-caching-for-static-files">Controlling caching for static files</h2>

<p>Django <a href="https://docs.djangoproject.com/en/1.9/howto/static-files/deployment/" title="Django: Deploying static files">recommends</a> serving static files separately from the rest of your
application.</p>

<p>However, for simplicity and dev-prod parity we’ve been using <a href="https://github.com/kennethreitz/dj-static" title="Github: DJ-Static">DJ-Static</a> to
serve static files with the Django WSGI app, as <a href="http://www.kennethreitz.org/essays/introducing-dj-static" title="Introducing DJ-Static">introduced by Kenneth Reitz</a>.
This was also, at the time we implemented it, the method recommended by Heroku
for managing static files in Django.</p>

<p>However, as it turns out DJ-Static doesn’t offer any control over caching
headers. And Heroku <a href="https://devcenter.heroku.com/articles/django-assets" title="Heroku: Django and Static Assets">now recommend</a> using <a href="http://whitenoise.evans.io/en/stable/" title="WhiteNoise: Radically simplified static file serving for Python web apps">WhiteNoise</a> instead.</p>

<p>Serving static files with WhiteNoise is pretty simple (as it was with DJ-Static):</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># myapp/settings.py
</span><span class="n">STATIC_ROOT</span> <span class="o">=</span> <span class="s">'static'</span>
<span class="n">STATIC_URL</span> <span class="o">=</span> <span class="s">'/static/'</span>

<span class="c1"># myapp/wsgi.py
</span><span class="kn">from</span> <span class="nn">django.core.wsgi</span> <span class="kn">import</span> <span class="n">get_wsgi_application</span>
<span class="kn">from</span> <span class="nn">whitenoise.django</span> <span class="kn">import</span> <span class="n">DjangoWhiteNoise</span>

<span class="n">application</span> <span class="o">=</span> <span class="n">DjangoWhiteNoise</span><span class="p">(</span><span class="n">get_wsgi_application</span><span class="p">())</span>
</code></pre></div></div>

<p>WhiteNoise will add a <code class="language-plaintext highlighter-rouge">Cache-Control</code> header, although it doesn’t
support set the older <code class="language-plaintext highlighter-rouge">Expires</code> header. By default, the <code class="language-plaintext highlighter-rouge">Cache-Control</code> header
is initially set to no caching:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>curl <span class="nt">-I</span> localhost:8000/static/css/styles.css?v<span class="o">=</span>d5d2934
...
Cache-Control: public, max-age<span class="o">=</span>0
</code></pre></div></div>

<p>We wanted our static files to be cached for a year, so we set the
<code class="language-plaintext highlighter-rouge">WHITENOISE_MAX_AGE</code> setting in <code class="language-plaintext highlighter-rouge">settings.py</code>:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># myapp/settings.py
</span><span class="n">WHITENOISE_MAX_AGE</span> <span class="o">=</span> <span class="mi">31557600</span>
</code></pre></div></div>

<p>This will set the <code class="language-plaintext highlighter-rouge">max-age</code> in the <code class="language-plaintext highlighter-rouge">Cache-Control</code> header to achieve the
browser caching we’re looking for:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>curl <span class="nt">-I</span> http://cn.ubuntu.com/static/css/styles.css?v<span class="o">=</span>d5d2934
...
Cache-Control: public, max-age<span class="o">=</span>31557600
</code></pre></div></div>

<h2 id="now-we-have-control">Now we have control</h2>

<p><a href="https://developers.google.com/speed/docs/insights/LeverageBrowserCaching" title="PageSpeed Insights: Leverage Browser Caching">Leveraging browser caching</a> is an invaluable tool in performance, and so
understanding how we can control the user’s cache with Django is very helpful.</p>

<p>Hopefully I’ve demonstrated some ways that this can be achieved, which we’ve
just implemented on <a href="http://cn.ubuntu.com">cn.ubuntu.com</a>.</p>



  
</article>

<script>
  /**
   * Document outline
   */

  // Get elements
  let article = document.querySelector("article");
  let headings = document.querySelector(".headings");
  let list = headings.querySelector("ol");

  // Populate nav
  article.querySelectorAll("h1, h2").forEach(function (heading) {
    let item = document.createElement("li");
    item.classList.add(heading.tagName.toLowerCase());
    item.innerHTML = `<a href="#${heading.id}">${heading.textContent}</a>`;
    list.appendChild(item);
  });

  function toggleHeadings() {
    // Don't show if there's not space
    if (article.offsetLeft < 180) {
      headings.style.display = "none";
      return;
    }

    // More compact layout
    if (article.offsetLeft < 350) {
      list.style.marginRight = "1.5em";
    } else {
      list.style.marginRight = "6em";
    }

    let articleBounding = article.getBoundingClientRect();
    let rightOffset = document.body.offsetWidth - articleBounding.left;

    headings.style.display = "block";
    headings.style.right = rightOffset + "px";

    if (articleBounding.top > 0) {
      headings.style.top = articleBounding.top + "px";
    } else {
      headings.style.top = 0;
    }
  }

  window.addEventListener('scroll', toggleHeadings);
  window.addEventListener('resize', toggleHeadings);

  toggleHeadings();
</script>

<address class="author">
  By <a href="https://twitter.com/nottrobin">@nottrobin</a>
</address>





<nav class="more-posts">
  <h2>More posts</h2>
  
  <p>
    <a href="/blogging-from-my-phone-with-gitjournal">Blogging from my phone with GitJournal</a><br>
    <time datetime="2022-06-05">5th June 2022</time>
  </p>
  
  
  <p>
    <a href="/fix-docker-networking-dns">Fix Docker's networking DNS config</a><br>
    <time datetime="2016-06-22">22nd June 2016</time>
  </p>
  
  
  <p>
    <a href="/simplest-wsgi-application">Creating a minimal Python application server for experimenting</a><br>
    <time datetime="2016-02-13">13th February 2016</time>
  </p>
  
</nav>


  <footer class="see-the-code">
    <a href="https://github.com/nottrobin/robinwinslow.uk">☵ See the code</a>
  </footer>

  <!-- Instant.page -->
  <script>
    let mouseoverTimer; let lastTouchTimestamp; const prefetches = new Set; const prefetchElement = document.createElement("link"); const isSupported = prefetchElement.relList && prefetchElement.relList.supports && prefetchElement.relList.supports("prefetch") && window.IntersectionObserver && "isIntersecting" in IntersectionObserverEntry.prototype; const allowQueryString = "instantAllowQueryString" in document.body.dataset; const allowExternalLinks = "instantAllowExternalLinks" in document.body.dataset; const useWhitelist = "instantWhitelist" in document.body.dataset; const mousedownShortcut = "instantMousedownShortcut" in document.body.dataset; const DELAY_TO_NOT_BE_CONSIDERED_A_TOUCH_INITIATED_ACTION = 1111; let delayOnHover = 65; let useMousedown = false; let useMousedownOnly = false; let useViewport = false; if ("instantIntensity" in document.body.dataset) { const intensity = document.body.dataset.instantIntensity; if (intensity.substr(0, "mousedown".length) == "mousedown") { useMousedown = true; if (intensity == "mousedown-only") { useMousedownOnly = true } } else if (intensity.substr(0, "viewport".length) == "viewport") { if (!(navigator.connection && (navigator.connection.saveData || navigator.connection.effectiveType && navigator.connection.effectiveType.includes("2g")))) { if (intensity == "viewport") { if (document.documentElement.clientWidth * document.documentElement.clientHeight < 45e4) { useViewport = true } } else if (intensity == "viewport-all") { useViewport = true } } } else { const milliseconds = parseInt(intensity); if (!isNaN(milliseconds)) { delayOnHover = milliseconds } } } if (isSupported) { const eventListenersOptions = { capture: true, passive: true }; if (!useMousedownOnly) { document.addEventListener("touchstart", touchstartListener, eventListenersOptions) } if (!useMousedown) { document.addEventListener("mouseover", mouseoverListener, eventListenersOptions) } else if (!mousedownShortcut) { document.addEventListener("mousedown", mousedownListener, eventListenersOptions) } if (mousedownShortcut) { document.addEventListener("mousedown", mousedownShortcutListener, eventListenersOptions) } if (useViewport) { let triggeringFunction; if (window.requestIdleCallback) { triggeringFunction = (callback => { requestIdleCallback(callback, { timeout: 1500 }) }) } else { triggeringFunction = (callback => { callback() }) } triggeringFunction(() => { const intersectionObserver = new IntersectionObserver(entries => { entries.forEach(entry => { if (entry.isIntersecting) { const linkElement = entry.target; intersectionObserver.unobserve(linkElement); preload(linkElement.href) } }) }); document.querySelectorAll("a").forEach(linkElement => { if (isPreloadable(linkElement)) { intersectionObserver.observe(linkElement) } }) }) } } function touchstartListener(event) { lastTouchTimestamp = performance.now(); const linkElement = event.target.closest("a"); if (!isPreloadable(linkElement)) { return } preload(linkElement.href) } function mouseoverListener(event) { if (performance.now() - lastTouchTimestamp < DELAY_TO_NOT_BE_CONSIDERED_A_TOUCH_INITIATED_ACTION) { return } const linkElement = event.target.closest("a"); if (!isPreloadable(linkElement)) { return } linkElement.addEventListener("mouseout", mouseoutListener, { passive: true }); mouseoverTimer = setTimeout(() => { preload(linkElement.href); mouseoverTimer = undefined }, delayOnHover) } function mousedownListener(event) { const linkElement = event.target.closest("a"); if (!isPreloadable(linkElement)) { return } preload(linkElement.href) } function mouseoutListener(event) { if (event.relatedTarget && event.target.closest("a") == event.relatedTarget.closest("a")) { return } if (mouseoverTimer) { clearTimeout(mouseoverTimer); mouseoverTimer = undefined } } function mousedownShortcutListener(event) { if (performance.now() - lastTouchTimestamp < DELAY_TO_NOT_BE_CONSIDERED_A_TOUCH_INITIATED_ACTION) { return } const linkElement = event.target.closest("a"); if (event.which > 1 || event.metaKey || event.ctrlKey) { return } if (!linkElement) { return } linkElement.addEventListener("click", function (event) { if (event.detail == 1337) { return } event.preventDefault() }, { capture: true, passive: false, once: true }); const customEvent = new MouseEvent("click", { view: window, bubbles: true, cancelable: false, detail: 1337 }); linkElement.dispatchEvent(customEvent) } function isPreloadable(linkElement) { if (!linkElement || !linkElement.href) { return } if (useWhitelist && !("instant" in linkElement.dataset)) { return } if (!allowExternalLinks && linkElement.origin != location.origin && !("instant" in linkElement.dataset)) { return } if (!["http:", "https:"].includes(linkElement.protocol)) { return } if (linkElement.protocol == "http:" && location.protocol == "https:") { return } if (!allowQueryString && linkElement.search && !("instant" in linkElement.dataset)) { return } if (linkElement.hash && linkElement.pathname + linkElement.search == location.pathname + location.search) { return } if ("noInstant" in linkElement.dataset) { return } return true } function preload(url) { if (prefetches.has(url)) { return } const prefetcher = document.createElement("link"); prefetcher.rel = "prefetch"; prefetcher.href = url; document.head.appendChild(prefetcher); prefetches.add(url) }
  </script>
</body>

</html>
