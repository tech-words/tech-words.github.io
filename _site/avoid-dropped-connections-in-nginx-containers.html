<!doctype html>

<!--
## Features:

- Keep CSS inline: It will be small enough not to add much weight to the page, which means it's better to avoid the extra HTTP call to request CSS
- Use system fonts: But it's hard to find a nice system font for both Linux, Windows and MacOS

- Google colours for links
- Visual box around article to highlight it
- Navigation - don't get in the way
- 

JavaScript:

- Only use enhancements that aren't necessary:
  - Document outline on the left
  - Add "title" to links

-->

<html lang="en">

<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Avoiding dropped connections in nginx containers with "STOPSIGNAL SIGQUIT"</title>

  <meta name="description" content="By default, Nginx will terminate abruptly when stopped. This can easily lead to dropped connections in production services. SIGQUIT is the answer.">

  <!-- Social media -->
  <meta property='article:author' content='https://twitter.com/nottrobin' />
  <meta property='article:publisher' content='https://robinwinslow.uk' />
  <meta property="og:image" content="https://www.thebluediamondgallery.com/tablet/images/blog.jpg" />
  <meta property="og:url" content="https://robinwinslow.uk/avoid-dropped-connections-in-nginx-containers" />
  <meta property="og:type" content="article" />
  <meta property="og:title" content="Avoiding dropped connections in nginx containers with "STOPSIGNAL SIGQUIT"" />
  <!-- Keep Terry Pratchett alive in the network https://xclacksoverhead.org/home/about -->
  <meta http-equiv="x-clacks-overhead" content="GNU Terry Pratchett" />

  <link type="application/atom+xml" rel="alternative" href="/rss.xml" />

  <style>
    /**
       * Font size
       * 
       * For usability, bigger text is almost always better. People continue to Especially as resolutions get higher
       * 
       */

    body {
      font-family: "dejavu Sans light", sans-serif;
      font-size: 1.5rem;
      background-color: #efefef;
      margin: 0;
    }

    time,
    .subtitle {
      color: #767676;
    }

    h1,
    h2,
    h3,
    h4 {
      font-weight: normal;
      margin-top: 2em;
      margin-bottom: 1em;
    }

    h1 {
      font-size: 2em;
    }

    h2 {
      font-size: 1.5em;
    }

    h3 {
      font-size: 1.2em;
    }

    h4 {
      font-size: 1.1em;
    }

    p {
      line-height: 1.5em;
    }

    a {
      color: #1a0dab;
      text-decoration: none;
    }

    a:hover {
      text-decoration: underline;
    }

    a:visited {
      color: #551A8B;
    }

    input,
    button {
      appearance: none;
      border: 1px solid lightgray;
      font-size: 1em;
      max-width: 100%;
      padding: 0.5em 0.8em;
    }

    article {
      margin: auto;
      padding: 3em 5em;
      max-width: 35em;
      background-color: white;
    }

    @media (max-width: 1080px) {
      article {
        padding: 0.5em 1.5em;
      }
    }

    article p,
    article ul,
    article ol {
      margin-block-start: 1.5em;
      margin-block-end: 1.5em;
    }

    article li {
      margin-block-start: 1em;
      margin-block-end: 1em;
      line-height: 1.5em;
    }

    blockquote {
      padding: 1em 1.5em;
      margin: 1.5em 0;
      border-left: 2px solid #ddd;
      font-style: italic;
    }

    blockquote p {
      display: inline;
    }

    pre {
      overflow-x: auto;
      background-color: #eee;
      padding: 1em;
      line-height: 125%;
    }

    img {
      max-width: 100%;
    }

    code {
      padding: 0.125em 0.25em;
      line-height: 1.6em;
      margin: 0;
      font-size: 0.8em;
      background-color: #f0f0f0;
      border-radius: 6px;
    }

    pre code {
      line-height: inherit;
      padding: 0;
    }

    hr {
      margin: 3em 0;
    }

    /* Classes */
    .article-header {
      margin: auto;
      max-width: 60em;
      padding: 3em 1em;
      text-align: center;
    }

    .article-header h1 {
      font-size: 3em;
      margin: 0 0 0.5em 0;
    }

    @media (max-width: 1080px) {
      .article-header h1 {
        font-size: 2.3em;
      }
    }

    .back-to-home {
      padding: 0 1.5em;
    }

    .title {
      text-align: center;
      margin: 1em 1em 2em 1em;
    }

    .title h1 {
      margin-bottom: 0;
    }

    .title p {
      margin-top: 0.25em;
    }

    .search-form {
      text-align: center;
      margin: 0.8em 1em;
    }

    .search-form input,
    .search-form button {
      margin: 0.2em 0;
    }

    .posts li {
      margin: 3em 0;
    }

    .posts li article {
      padding: 0.5em 3em;
    }

    .posts li article .date {
      margin-top: 0.5em;
      font-size: 0.8em;
    }

    @media (max-width: 984px) {
      .posts li article {
        padding: 1.5em;
      }
    }

    .posts li article h1 {
      font-size: 1.5em;
      margin: 1em 0 0 0;
      font-weight: normal;
    }

    @media (max-width: 984px) {
      .posts li article h1 {
        font-size: 1.3em;
      }
    }

    .posts {
      padding: 0;
      margin: 0;
      list-style-type: none;
    }

    .see-the-code {
      padding: 1.5em;
      font-size: 0.8em;
      text-align: right;
    }

    .discuss {
      text-align: center;
      font-style: italic;
    }

    .author {
      text-align: center;
      margin: 3em;
      font-style: normal;
    }

    .more-posts {
      padding: 1.5em 3em;
      margin: auto;
      background-color: white;
      max-width: 35em;
    }

    .more-posts h2 {
      margin-top: 1em;
    }

    .more-posts time {
      font-size: 0.8em;
    }

    .headings {
      position: absolute;
      text-align: right;
      font-size: 0.8em;
      opacity: 0.5;
      position: fixed;
      display: none;
    }

    .headings ol {
      margin: 6em 6em 1.5em 1.5em;
      padding: 0;
    }

    .headings ol li {
      list-style-type: none;
      margin: 1.5em 0 0 0;
    }

    .headings ol li.h2 {
      font-size: 0.8em;
      opacity: 0.8;
      margin: 0.7em 0 0 0;
    }

    .heading-link {
      opacity: 0.4;
      font-size: 2rem;
    }

    table {
      border-spacing: 0;
      font-size: 0.8em;
    }

    td {
      padding: 1em;
      border-left: 1px dotted #666;
      border-top: 1px dotted #666;
    }

    td:last-child {
      border-right: 1px dotted #666;
    }

    tr:last-child td {
      border-bottom: 1px dotted #666;
    }

    /* Pygments syntax highlighting autumn theme */
    td.linenos pre {
      color: #000000;
      background-color: #f0f0f0;
      padding-left: 5px;
      padding-right: 5px;
    }

    span.linenos {
      color: #000000;
      background-color: #f0f0f0;
      padding-left: 5px;
      padding-right: 5px;
    }

    td.linenos pre.special {
      color: #000000;
      background-color: #ffffc0;
      padding-left: 5px;
      padding-right: 5px;
    }

    span.linenos.special {
      color: #000000;
      background-color: #ffffc0;
      padding-left: 5px;
      padding-right: 5px;
    }

    .highlight .hll {
      background-color: #ffffcc
    }

    .highlight {
      background: #f0f0f0;
    }

    .highlight .c {
      color: #60a0b0;
      font-style: italic
    }

    .highlight .err {
      border: 1px solid #FF0000
    }

    .highlight .k {
      color: #007020;
      font-weight: bold
    }

    .highlight .o {
      color: #666666
    }

    .highlight .ch {
      color: #60a0b0;
      font-style: italic
    }

    .highlight .cm {
      color: #60a0b0;
      font-style: italic
    }

    .highlight .cp {
      color: #007020
    }

    .highlight .cpf {
      color: #60a0b0;
      font-style: italic
    }

    .highlight .c1 {
      color: #60a0b0;
      font-style: italic
    }

    .highlight .cs {
      color: #60a0b0;
      background-color: #fff0f0
    }

    .highlight .gd {
      color: #A00000
    }

    .highlight .ge {
      font-style: italic
    }

    .highlight .gr {
      color: #FF0000
    }

    .highlight .gh {
      color: #000080;
      font-weight: bold
    }

    .highlight .gi {
      color: #00A000
    }

    .highlight .go {
      color: #888888
    }

    .highlight .gp {
      color: #c65d09;
      font-weight: bold
    }

    .highlight .gs {
      font-weight: bold
    }

    .highlight .gu {
      color: #800080;
      font-weight: bold
    }

    .highlight .gt {
      color: #0044DD
    }

    .highlight .kc {
      color: #007020;
      font-weight: bold
    }

    .highlight .kd {
      color: #007020;
      font-weight: bold
    }

    .highlight .kn {
      color: #007020;
      font-weight: bold
    }

    .highlight .kp {
      color: #007020
    }

    .highlight .kr {
      color: #007020;
      font-weight: bold
    }

    .highlight .kt {
      color: #902000
    }

    .highlight .m {
      color: #40a070
    }

    .highlight .s {
      color: #4070a0
    }

    .highlight .na {
      color: #4070a0
    }

    .highlight .nb {
      color: #007020
    }

    .highlight .nc {
      color: #0e84b5;
      font-weight: bold
    }

    .highlight .no {
      color: #60add5
    }

    .highlight .nd {
      color: #555555;
      font-weight: bold
    }

    .highlight .ni {
      color: #d55537;
      font-weight: bold
    }

    .highlight .ne {
      color: #007020
    }

    .highlight .nf {
      color: #06287e
    }

    .highlight .nl {
      color: #002070;
      font-weight: bold
    }

    .highlight .nn {
      color: #0e84b5;
      font-weight: bold
    }

    .highlight .nt {
      color: #062873;
      font-weight: bold
    }

    .highlight .nv {
      color: #bb60d5
    }

    .highlight .ow {
      color: #007020;
      font-weight: bold
    }

    .highlight .w {
      color: #bbbbbb
    }

    .highlight .mb {
      color: #40a070
    }

    .highlight .mf {
      color: #40a070
    }

    .highlight .mh {
      color: #40a070
    }

    .highlight .mi {
      color: #40a070
    }

    .highlight .mo {
      color: #40a070
    }

    .highlight .sa {
      color: #4070a0
    }

    .highlight .sb {
      color: #4070a0
    }

    .highlight .sc {
      color: #4070a0
    }

    .highlight .dl {
      color: #4070a0
    }

    .highlight .sd {
      color: #4070a0;
      font-style: italic
    }

    .highlight .s2 {
      color: #4070a0
    }

    .highlight .se {
      color: #4070a0;
      font-weight: bold
    }

    .highlight .sh {
      color: #4070a0
    }

    .highlight .si {
      color: #70a0d0;
      font-style: italic
    }

    .highlight .sx {
      color: #c65d09
    }

    .highlight .sr {
      color: #235388
    }

    .highlight .s1 {
      color: #4070a0
    }

    .highlight .ss {
      color: #517918
    }

    .highlight .bp {
      color: #007020
    }

    .highlight .fm {
      color: #06287e
    }

    .highlight .vc {
      color: #bb60d5
    }

    .highlight .vg {
      color: #bb60d5
    }

    .highlight .vi {
      color: #bb60d5
    }

    .highlight .vm {
      color: #bb60d5
    }

    .highlight .il {
      color: #40a070
    }
  </style>
</head>

<body>
  <nav class="back-to-home">
  <p><a href="/">← Posts</a></h1></p>
</nav>

<header class="article-header">
  <h1>Avoiding dropped connections in nginx containers with "STOPSIGNAL SIGQUIT"</h1>
  <time datetime="2019-11-18">18th November 2019</time>
</header>

<nav class="headings">
  <ol>
    <li><a href="#top">↑ top</a></li>
  </ol>
</nav>

<article>
  <p><em>Update: The default used in the official nginx docker image was changed from SIGTERM to SIGQUIT <a href="https://github.com/nginxinc/docker-nginx/commit/3fb70ddd7094c1fdd50cc83d432643dc10ab6243">in November 2020</a>, so this should no longer be an issue for Docker or Kubernetes users.</em></p>

<p><a href="https://www.nginx.com/resources/wiki/">nginx</a> is a very popular web server.</p>

<p>It may have just become the <em>most</em> popular web server, with 33% market share <a href="https://news.netcraft.com/archives/2019/10/24/october-2019-web-server-survey.html">according to the October 2019 Netcraft survey</a>. This may be in large part thanks to the <a href="https://dzone.com/articles/survey-reveals-rapid-growth-in-kubernetes-usage-se">growth in Kubernetes adoption</a>, as most Kubernetes installations use nginx as the <a href="https://github.com/kubernetes/ingress-nginx">default ingress controller</a>.</p>

<p>Unsurprisingly, its use <em>within</em> <a href="https://kubernetes.io/">Kubernetes configurations</a> is just as popular, with <a href="https://github.com/search?q=%22containers%3A%22+%22image%3A+nginx%22+filename%3A*.yaml&amp;type=Code">33k public projects</a> on GitHub using <a href="https://hub.docker.com/_/nginx">the nginx image</a> in configs, and <a href="https://github.com/search?q=filename%3ADockerfile+%28%22ENTRYPOINT+nginx%22+OR+%22CMD+nginx%22%29&amp;type=Code">at least as many</a> running it in their own <a href="https://docs.docker.com/install/">Docker</a> images.</p>

<p>We run nginx in the docker images for our <a href="https://github.com/search?p=1&amp;q=topic%3Awebsite+org%3Acanonical-web-and-design+%22CMD+nginx%22&amp;type=Code">15 static websites</a> running on our team’s <a href="https://ubuntu.com/kubernetes">Charmed Kubernetes</a> cluster.</p>

<h2 id="closing-connections-in-usnubuntucom">Closing connections in usn.ubuntu.com</h2>

<p>About 2 years ago <a href="https://github.com/canonical-web-and-design/deployment-configs/pull/62">we noticed</a> a problem in downloads of <a href="https://usn.ubuntu.com/usn-db/database-all.pickle.bz2">our database of Ubuntu Security Notices</a>, with clients having their connections reset during the download.</p>

<p>This may have had a few causes, but one very likely culprit was Kubernetes restarting or replacing containers. This may happen during normal running of the service, as Kubernetes reschedules pods to respond to load, but will also happen every time we release a new version of the site.</p>

<h2 id="the-trouble-with-sigterm-and-nginx">The trouble with <code class="language-plaintext highlighter-rouge">SIGTERM</code> and nginx</h2>

<p>When we release a new version of a site to Kubernetes, we first build and push a new image to the registry, then we ask Kubernetes to gradually roll out new containers based off the new image.</p>

<p>Kubernetes will gradually switch over to the new containers, removing the old ones as it goes. It does this using the same mechanism as <a href="https://docs.docker.com/engine/reference/commandline/stop/"><code class="language-plaintext highlighter-rouge">docker stop</code></a> - it will send a SIGTERM <a href="https://en.wikipedia.org/wiki/Signal_(IPC)#POSIX_signals">signal</a> to the container, allow 30 seconds for it to stop gracefully, then send SIGKILL. It expects SIGTERM to result in a graceful shutdown:</p>

<blockquote>
  <p>“It’s important that your application handle termination gracefully so that there is minimal impact on the end user and the time-to-recovery is as fast as possible!</p>

  <p>In practice, this means your application needs to handle the SIGTERM message and begin shutting down when it receives it. This means saving all data that needs to be saved, closing down network connections, finishing any work that is left, and other similar tasks.”</p>
</blockquote>

<p><em>From <a href="https://cloud.google.com/blog/products/gcp/kubernetes-best-practices-terminating-with-grace">Kubernetes best practices: terminating with grace</a> by Sandeep Dinesh</em></p>

<p>Unfortunately, this isn’t what happens when nginx receives a TERM signal:</p>

<blockquote>
  <p>“The master process supports the following signals:</p>

  <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>TERM, INT    fast shutdown
QUIT        graceful shutdown”
</code></pre></div>  </div>
</blockquote>

<p><em>From the “<a href="http://nginx.org/en/docs/control.html">Controlling nginx</a>” documentation</em></p>

<p>What that “fast shutdown” means is that any open connections will be immediately closed. So if Kubernetes sends <code class="language-plaintext highlighter-rouge">SIGTERM</code> to my running containers, anyone with an open connection to those containers will see their connection break.</p>

<p>We can illustrate this using <a href="https://gist.github.com/nottrobin/60d949fd41c99b8c77fb23f614b126f8">a Dockerfile</a> which simply uses nginx to proxy to <a href="https://httpbin.org/delay/10"><code class="language-plaintext highlighter-rouge">httpbin.org/delay/10</code></a>. When we stop the container, we can see the container exit within less than a second, and the <code class="language-plaintext highlighter-rouge">curl</code> exit with “Empty reply from server”:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ docker build -t delay-image .
...
Successfully tagged delay-image:latest
 
$ docker run --rm --name delay-ctnr --detach --publish 80:80 delay-image
E5F6789...

$ curl -I localhost 2&gt;&amp;1 | egrep 'curl:|HTTP' &amp;
[1] 14531

$ /usr/bin/time --format '%E' docker stop delay-ctnr
curl: (52) Empty reply from server
delay-ctnr
0:00.56
</code></pre></div></div>

<h2 id="sigquit-to-the-rescue">SIGQUIT to the rescue</h2>

<p>What we need instead is to send a <code class="language-plaintext highlighter-rouge">SIGQUIT</code> signal to ask nginx to perform a graceful shutdown, where it will wait for open connections to close before quitting.</p>

<p>If we  <a href="https://gist.github.com/nottrobin/79087f07efab61f013c6e7e519a96ad8">add <code class="language-plaintext highlighter-rouge">STOPSIGNAL SIGQUIT</code> to the Dockerfile</a> then we can instead see curl exit gracefully with a <a href="https://en.wikipedia.org/wiki/List_of_HTTP_status_codes#2xx_Success">successful 200 response</a>, and <code class="language-plaintext highlighter-rouge">docker stop</code> wait (in this case, for 8.51 seconds) until it’s done so:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ docker build -t delay-image .
...
Successfully tagged delay-image:latest

$ docker run --rm --name delay-ctnr --detach --publish 80:80 delay-image
A1B2C3D4...

$ curl -I localhost 2&gt;&amp;1 | egrep 'curl:|HTTP' &amp;
[1] 14533

$ /usr/bin/time --format '%E' docker stop delay-ctnr
HTTP/1.1 200 OK
delay-ctnr
0:08.51
</code></pre></div></div>

<p>Bear in mind that <code class="language-plaintext highlighter-rouge">docker kill</code> will only wait 10 seconds, and Kubernetes will only wait 30, before killing the container with <code class="language-plaintext highlighter-rouge">SIGKILL</code>. So if you might need longer than that to close connections then you may need to increase the grace period.</p>

<p>An exception to this rule is if you are relying on unix sockets in your nginx config. In this case, <code class="language-plaintext highlighter-rouge">SIGQUIT</code> will <a href="https://trac.nginx.org/nginx/ticket/753">fail to close the sockets</a> properly, resulting in <a href="https://github.com/nginxinc/docker-nginx/issues/167">containers potentially not restarting correctly</a>. So if you’re using sockets, be careful with SIGQUIT.</p>

<h2 id="why-isnt-this-default">Why isn’t this default?</h2>

<p>I can’t find any reference to why nginx made the decision not to treat <code class="language-plaintext highlighter-rouge">SIGTERM</code> more gracefully, as a graceful termination seems to be the norm with <code class="language-plaintext highlighter-rouge">SIGTERM</code>.</p>

<blockquote>
  <p>The <code class="language-plaintext highlighter-rouge">SIGTERM</code> signal is sent to a process to request its <strong>termination</strong>. […] This allows the process to perform nice termination releasing resources and saving state if appropriate.</p>
</blockquote>

<p><em>From <a href="https://en.wikipedia.org/w/index.php?title=Signal_(IPC)&amp;oldid=924696609">Wikipedia: Signal (IPC)</a></em></p>

<p><del>What is a shame is that the Dockerfile for the default nginx Docker image <a href="https://github.com/nginxinc/docker-nginx/blob/fe97d699daae7e04f916771ac520f7cf25ab2b27/mainline/buster/Dockerfile#L101">explicitly uses</a> <code class="language-plaintext highlighter-rouge">STOPSIGNAL SIGTERM</code>, meaning that anyone using the default image (and anyone copying it) will get this connection closing issue.</del></p>

<p><del>They have made the decision to use SIGTERM rather than SIGQUIT <a href="https://github.com/nginxinc/docker-nginx/issues/167">because of the issue with sockets</a>. But if you’re not using sockets, you should definitely use SIGQUIT instead.</del></p>

<p><em>Edit: Since November 2020, the official docker image now uses SIGQUIT, so termination should now be graceful in Docker and Kubernetes.</em></p>

<p><em>(This was <a href="https://ubuntu.com/blog/avoiding-dropped-connections-in-nginx-containers-with-stopsignal-sigquit">originally published on the Ubuntu blog</a>)</em></p>


  
</article>

<script>
  /**
   * Document outline
   */

  // Get elements
  let article = document.querySelector("article");
  let headings = document.querySelector(".headings");
  let list = headings.querySelector("ol");

  // Populate nav
  article.querySelectorAll("h1, h2").forEach(function (heading) {
    let item = document.createElement("li");
    item.classList.add(heading.tagName.toLowerCase());
    item.innerHTML = `<a href="#${heading.id}">${heading.textContent}</a>`;
    list.appendChild(item);
  });

  function toggleHeadings() {
    // Don't show if there's not space
    if (article.offsetLeft < 180) {
      headings.style.display = "none";
      return;
    }

    // More compact layout
    if (article.offsetLeft < 350) {
      list.style.marginRight = "1.5em";
    } else {
      list.style.marginRight = "6em";
    }

    let articleBounding = article.getBoundingClientRect();
    let rightOffset = document.body.offsetWidth - articleBounding.left;

    headings.style.display = "block";
    headings.style.right = rightOffset + "px";

    if (articleBounding.top > 0) {
      headings.style.top = articleBounding.top + "px";
    } else {
      headings.style.top = 0;
    }
  }

  window.addEventListener('scroll', toggleHeadings);
  window.addEventListener('resize', toggleHeadings);

  toggleHeadings();
</script>

<address class="author">
  By <a href="https://twitter.com/nottrobin">@nottrobin</a>
</address>





<nav class="more-posts">
  <h2>More posts</h2>
  
  <p>
    <a href="/blogging-from-my-phone-with-gitjournal">Blogging from my phone with GitJournal</a><br>
    <time datetime="2022-06-05">5th June 2022</time>
  </p>
  
  
  <p>
    <a href="/pragmatic-testing">Effective testing (work in progress)</a><br>
    <time datetime="2020-06-30">30th June 2020</time>
  </p>
  
  
  <p>
    <a href="/learning-lxd">How to use Linux Containers with LXD, and why you might want to</a><br>
    <time datetime="2019-02-04">4th February 2019</time>
  </p>
  
</nav>


  <footer class="see-the-code">
    <a href="https://github.com/nottrobin/robinwinslow.uk">☵ See the code</a>
  </footer>

  <!-- Instant.page -->
  <script>
    let mouseoverTimer; let lastTouchTimestamp; const prefetches = new Set; const prefetchElement = document.createElement("link"); const isSupported = prefetchElement.relList && prefetchElement.relList.supports && prefetchElement.relList.supports("prefetch") && window.IntersectionObserver && "isIntersecting" in IntersectionObserverEntry.prototype; const allowQueryString = "instantAllowQueryString" in document.body.dataset; const allowExternalLinks = "instantAllowExternalLinks" in document.body.dataset; const useWhitelist = "instantWhitelist" in document.body.dataset; const mousedownShortcut = "instantMousedownShortcut" in document.body.dataset; const DELAY_TO_NOT_BE_CONSIDERED_A_TOUCH_INITIATED_ACTION = 1111; let delayOnHover = 65; let useMousedown = false; let useMousedownOnly = false; let useViewport = false; if ("instantIntensity" in document.body.dataset) { const intensity = document.body.dataset.instantIntensity; if (intensity.substr(0, "mousedown".length) == "mousedown") { useMousedown = true; if (intensity == "mousedown-only") { useMousedownOnly = true } } else if (intensity.substr(0, "viewport".length) == "viewport") { if (!(navigator.connection && (navigator.connection.saveData || navigator.connection.effectiveType && navigator.connection.effectiveType.includes("2g")))) { if (intensity == "viewport") { if (document.documentElement.clientWidth * document.documentElement.clientHeight < 45e4) { useViewport = true } } else if (intensity == "viewport-all") { useViewport = true } } } else { const milliseconds = parseInt(intensity); if (!isNaN(milliseconds)) { delayOnHover = milliseconds } } } if (isSupported) { const eventListenersOptions = { capture: true, passive: true }; if (!useMousedownOnly) { document.addEventListener("touchstart", touchstartListener, eventListenersOptions) } if (!useMousedown) { document.addEventListener("mouseover", mouseoverListener, eventListenersOptions) } else if (!mousedownShortcut) { document.addEventListener("mousedown", mousedownListener, eventListenersOptions) } if (mousedownShortcut) { document.addEventListener("mousedown", mousedownShortcutListener, eventListenersOptions) } if (useViewport) { let triggeringFunction; if (window.requestIdleCallback) { triggeringFunction = (callback => { requestIdleCallback(callback, { timeout: 1500 }) }) } else { triggeringFunction = (callback => { callback() }) } triggeringFunction(() => { const intersectionObserver = new IntersectionObserver(entries => { entries.forEach(entry => { if (entry.isIntersecting) { const linkElement = entry.target; intersectionObserver.unobserve(linkElement); preload(linkElement.href) } }) }); document.querySelectorAll("a").forEach(linkElement => { if (isPreloadable(linkElement)) { intersectionObserver.observe(linkElement) } }) }) } } function touchstartListener(event) { lastTouchTimestamp = performance.now(); const linkElement = event.target.closest("a"); if (!isPreloadable(linkElement)) { return } preload(linkElement.href) } function mouseoverListener(event) { if (performance.now() - lastTouchTimestamp < DELAY_TO_NOT_BE_CONSIDERED_A_TOUCH_INITIATED_ACTION) { return } const linkElement = event.target.closest("a"); if (!isPreloadable(linkElement)) { return } linkElement.addEventListener("mouseout", mouseoutListener, { passive: true }); mouseoverTimer = setTimeout(() => { preload(linkElement.href); mouseoverTimer = undefined }, delayOnHover) } function mousedownListener(event) { const linkElement = event.target.closest("a"); if (!isPreloadable(linkElement)) { return } preload(linkElement.href) } function mouseoutListener(event) { if (event.relatedTarget && event.target.closest("a") == event.relatedTarget.closest("a")) { return } if (mouseoverTimer) { clearTimeout(mouseoverTimer); mouseoverTimer = undefined } } function mousedownShortcutListener(event) { if (performance.now() - lastTouchTimestamp < DELAY_TO_NOT_BE_CONSIDERED_A_TOUCH_INITIATED_ACTION) { return } const linkElement = event.target.closest("a"); if (event.which > 1 || event.metaKey || event.ctrlKey) { return } if (!linkElement) { return } linkElement.addEventListener("click", function (event) { if (event.detail == 1337) { return } event.preventDefault() }, { capture: true, passive: false, once: true }); const customEvent = new MouseEvent("click", { view: window, bubbles: true, cancelable: false, detail: 1337 }); linkElement.dispatchEvent(customEvent) } function isPreloadable(linkElement) { if (!linkElement || !linkElement.href) { return } if (useWhitelist && !("instant" in linkElement.dataset)) { return } if (!allowExternalLinks && linkElement.origin != location.origin && !("instant" in linkElement.dataset)) { return } if (!["http:", "https:"].includes(linkElement.protocol)) { return } if (linkElement.protocol == "http:" && location.protocol == "https:") { return } if (!allowQueryString && linkElement.search && !("instant" in linkElement.dataset)) { return } if (linkElement.hash && linkElement.pathname + linkElement.search == location.pathname + location.search) { return } if ("noInstant" in linkElement.dataset) { return } return true } function preload(url) { if (prefetches.has(url)) { return } const prefetcher = document.createElement("link"); prefetcher.rel = "prefetch"; prefetcher.href = url; document.head.appendChild(prefetcher); prefetches.add(url) }
  </script>
</body>

</html>
