<!doctype html>

<!--
## Features:

- Keep CSS inline: It will be small enough not to add much weight to the page, which means it's better to avoid the extra HTTP call to request CSS
- Use system fonts: But it's hard to find a nice system font for both Linux, Windows and MacOS

- Google colours for links
- Visual box around article to highlight it
- Navigation - don't get in the way
- 

JavaScript:

- Only use enhancements that aren't necessary:
  - Document outline on the left
  - Add "title" to links

-->

<html lang="en">

<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>How to use Linux Containers with LXD, and why you might want to</title>

  <meta name="description" content="Getting up and running with LXD containers - Quick usage; basic networking; sharing folders with write access">

  <!-- Social media -->
  <meta property='article:author' content='https://twitter.com/nottrobin' />
  <meta property='article:publisher' content='https://robinwinslow.uk' />
  <meta property="og:image" content="https://www.thebluediamondgallery.com/tablet/images/blog.jpg" />
  <meta property="og:url" content="https://robinwinslow.uk/learning-lxd" />
  <meta property="og:type" content="article" />
  <meta property="og:title" content="How to use Linux Containers with LXD, and why you might want to" />
  <!-- Keep Terry Pratchett alive in the network https://xclacksoverhead.org/home/about -->
  <meta http-equiv="x-clacks-overhead" content="GNU Terry Pratchett" />

  <link type="application/atom+xml" rel="alternative" href="/rss.xml" />

  <style>
    /**
       * Font size
       * 
       * For usability, bigger text is almost always better. People continue to Especially as resolutions get higher
       * 
       */

    body {
      font-family: "dejavu Sans light", sans-serif;
      font-size: 1.5rem;
      background-color: #efefef;
      margin: 0;
    }

    time,
    .subtitle {
      color: #767676;
    }

    h1,
    h2,
    h3,
    h4 {
      font-weight: normal;
      margin-top: 2em;
      margin-bottom: 1em;
    }

    h1 {
      font-size: 2em;
    }

    h2 {
      font-size: 1.5em;
    }

    h3 {
      font-size: 1.2em;
    }

    h4 {
      font-size: 1.1em;
    }

    p {
      line-height: 1.5em;
    }

    a {
      color: #1a0dab;
      text-decoration: none;
    }

    a:hover {
      text-decoration: underline;
    }

    a:visited {
      color: #551A8B;
    }

    input,
    button {
      appearance: none;
      border: 1px solid lightgray;
      font-size: 1em;
      max-width: 100%;
      padding: 0.5em 0.8em;
    }

    article {
      margin: auto;
      padding: 3em 5em;
      max-width: 35em;
      background-color: white;
    }

    @media (max-width: 1080px) {
      article {
        padding: 0.5em 1.5em;
      }
    }

    article p,
    article ul,
    article ol {
      margin-block-start: 1.5em;
      margin-block-end: 1.5em;
    }

    article li {
      margin-block-start: 1em;
      margin-block-end: 1em;
      line-height: 1.5em;
    }

    blockquote {
      padding: 1em 1.5em;
      margin: 1.5em 0;
      border-left: 2px solid #ddd;
      font-style: italic;
    }

    blockquote p {
      display: inline;
    }

    pre {
      overflow-x: auto;
      background-color: #eee;
      padding: 1em;
      line-height: 125%;
    }

    img {
      max-width: 100%;
    }

    code {
      padding: 0.125em 0.25em;
      line-height: 1.6em;
      margin: 0;
      font-size: 0.8em;
      background-color: #f0f0f0;
      border-radius: 6px;
    }

    pre code {
      line-height: inherit;
      padding: 0;
    }

    hr {
      margin: 3em 0;
    }

    /* Classes */
    .article-header {
      margin: auto;
      max-width: 60em;
      padding: 3em 1em;
      text-align: center;
    }

    .article-header h1 {
      font-size: 3em;
      margin: 0 0 0.5em 0;
    }

    @media (max-width: 1080px) {
      .article-header h1 {
        font-size: 2.3em;
      }
    }

    .back-to-home {
      padding: 0 1.5em;
    }

    .title {
      text-align: center;
      margin: 1em 1em 2em 1em;
    }

    .title h1 {
      margin-bottom: 0;
    }

    .title p {
      margin-top: 0.25em;
    }

    .search-form {
      text-align: center;
      margin: 0.8em 1em;
    }

    .search-form input,
    .search-form button {
      margin: 0.2em 0;
    }

    .posts li {
      margin: 3em 0;
    }

    .posts li article {
      padding: 0.5em 3em;
    }

    .posts li article .date {
      margin-top: 0.5em;
      font-size: 0.8em;
    }

    @media (max-width: 984px) {
      .posts li article {
        padding: 1.5em;
      }
    }

    .posts li article h1 {
      font-size: 1.5em;
      margin: 1em 0 0 0;
      font-weight: normal;
    }

    @media (max-width: 984px) {
      .posts li article h1 {
        font-size: 1.3em;
      }
    }

    .posts {
      padding: 0;
      margin: 0;
      list-style-type: none;
    }

    .see-the-code {
      padding: 1.5em;
      font-size: 0.8em;
      text-align: right;
    }

    .discuss {
      text-align: center;
      font-style: italic;
    }

    .author {
      text-align: center;
      margin: 3em;
      font-style: normal;
    }

    .more-posts {
      padding: 1.5em 3em;
      margin: auto;
      background-color: white;
      max-width: 35em;
    }

    .more-posts h2 {
      margin-top: 1em;
    }

    .more-posts time {
      font-size: 0.8em;
    }

    .headings {
      position: absolute;
      text-align: right;
      font-size: 0.8em;
      opacity: 0.5;
      position: fixed;
      display: none;
    }

    .headings ol {
      margin: 6em 6em 1.5em 1.5em;
      padding: 0;
    }

    .headings ol li {
      list-style-type: none;
      margin: 1.5em 0 0 0;
    }

    .headings ol li.h2 {
      font-size: 0.8em;
      opacity: 0.8;
      margin: 0.7em 0 0 0;
    }

    .heading-link {
      opacity: 0.4;
      font-size: 2rem;
    }

    table {
      border-spacing: 0;
      font-size: 0.8em;
    }

    td {
      padding: 1em;
      border-left: 1px dotted #666;
      border-top: 1px dotted #666;
    }

    td:last-child {
      border-right: 1px dotted #666;
    }

    tr:last-child td {
      border-bottom: 1px dotted #666;
    }

    /* Pygments syntax highlighting autumn theme */
    td.linenos pre {
      color: #000000;
      background-color: #f0f0f0;
      padding-left: 5px;
      padding-right: 5px;
    }

    span.linenos {
      color: #000000;
      background-color: #f0f0f0;
      padding-left: 5px;
      padding-right: 5px;
    }

    td.linenos pre.special {
      color: #000000;
      background-color: #ffffc0;
      padding-left: 5px;
      padding-right: 5px;
    }

    span.linenos.special {
      color: #000000;
      background-color: #ffffc0;
      padding-left: 5px;
      padding-right: 5px;
    }

    .highlight .hll {
      background-color: #ffffcc
    }

    .highlight {
      background: #f0f0f0;
    }

    .highlight .c {
      color: #60a0b0;
      font-style: italic
    }

    .highlight .err {
      border: 1px solid #FF0000
    }

    .highlight .k {
      color: #007020;
      font-weight: bold
    }

    .highlight .o {
      color: #666666
    }

    .highlight .ch {
      color: #60a0b0;
      font-style: italic
    }

    .highlight .cm {
      color: #60a0b0;
      font-style: italic
    }

    .highlight .cp {
      color: #007020
    }

    .highlight .cpf {
      color: #60a0b0;
      font-style: italic
    }

    .highlight .c1 {
      color: #60a0b0;
      font-style: italic
    }

    .highlight .cs {
      color: #60a0b0;
      background-color: #fff0f0
    }

    .highlight .gd {
      color: #A00000
    }

    .highlight .ge {
      font-style: italic
    }

    .highlight .gr {
      color: #FF0000
    }

    .highlight .gh {
      color: #000080;
      font-weight: bold
    }

    .highlight .gi {
      color: #00A000
    }

    .highlight .go {
      color: #888888
    }

    .highlight .gp {
      color: #c65d09;
      font-weight: bold
    }

    .highlight .gs {
      font-weight: bold
    }

    .highlight .gu {
      color: #800080;
      font-weight: bold
    }

    .highlight .gt {
      color: #0044DD
    }

    .highlight .kc {
      color: #007020;
      font-weight: bold
    }

    .highlight .kd {
      color: #007020;
      font-weight: bold
    }

    .highlight .kn {
      color: #007020;
      font-weight: bold
    }

    .highlight .kp {
      color: #007020
    }

    .highlight .kr {
      color: #007020;
      font-weight: bold
    }

    .highlight .kt {
      color: #902000
    }

    .highlight .m {
      color: #40a070
    }

    .highlight .s {
      color: #4070a0
    }

    .highlight .na {
      color: #4070a0
    }

    .highlight .nb {
      color: #007020
    }

    .highlight .nc {
      color: #0e84b5;
      font-weight: bold
    }

    .highlight .no {
      color: #60add5
    }

    .highlight .nd {
      color: #555555;
      font-weight: bold
    }

    .highlight .ni {
      color: #d55537;
      font-weight: bold
    }

    .highlight .ne {
      color: #007020
    }

    .highlight .nf {
      color: #06287e
    }

    .highlight .nl {
      color: #002070;
      font-weight: bold
    }

    .highlight .nn {
      color: #0e84b5;
      font-weight: bold
    }

    .highlight .nt {
      color: #062873;
      font-weight: bold
    }

    .highlight .nv {
      color: #bb60d5
    }

    .highlight .ow {
      color: #007020;
      font-weight: bold
    }

    .highlight .w {
      color: #bbbbbb
    }

    .highlight .mb {
      color: #40a070
    }

    .highlight .mf {
      color: #40a070
    }

    .highlight .mh {
      color: #40a070
    }

    .highlight .mi {
      color: #40a070
    }

    .highlight .mo {
      color: #40a070
    }

    .highlight .sa {
      color: #4070a0
    }

    .highlight .sb {
      color: #4070a0
    }

    .highlight .sc {
      color: #4070a0
    }

    .highlight .dl {
      color: #4070a0
    }

    .highlight .sd {
      color: #4070a0;
      font-style: italic
    }

    .highlight .s2 {
      color: #4070a0
    }

    .highlight .se {
      color: #4070a0;
      font-weight: bold
    }

    .highlight .sh {
      color: #4070a0
    }

    .highlight .si {
      color: #70a0d0;
      font-style: italic
    }

    .highlight .sx {
      color: #c65d09
    }

    .highlight .sr {
      color: #235388
    }

    .highlight .s1 {
      color: #4070a0
    }

    .highlight .ss {
      color: #517918
    }

    .highlight .bp {
      color: #007020
    }

    .highlight .fm {
      color: #06287e
    }

    .highlight .vc {
      color: #bb60d5
    }

    .highlight .vg {
      color: #bb60d5
    }

    .highlight .vi {
      color: #bb60d5
    }

    .highlight .vm {
      color: #bb60d5
    }

    .highlight .il {
      color: #40a070
    }
  </style>
</head>

<body>
  <nav class="back-to-home">
  <p><a href="/">← Posts</a></h1></p>
</nav>

<header class="article-header">
  <h1>How to use Linux Containers with LXD, and why you might want to</h1>
  <time datetime="2019-02-04">4th February 2019</time>
</header>

<nav class="headings">
  <ol>
    <li><a href="#top">↑ top</a></li>
  </ol>
</nav>

<article>
  <p><em>I initially <a href="https://github.com/nottrobin/robinwinslow.uk/blob/66be16a8281206c7fd41d7b403be2895f4b49c24/_posts/learning-lxd.md">drafted this</a> nearly 3 years ago. I didn’t publish it then (for no good reason), so I’m publishing it now.</em></p>

<p><em>I have gone through the article and made sure it still works with the latest LXD at the time of publishing. I also updated it to:</em></p>

<ul>
  <li><em>use <code class="language-plaintext highlighter-rouge">bionic</code> instead of <code class="language-plaintext highlighter-rouge">xenial</code></em></li>
  <li><em>cover <a href="https://snapcraft.io/lxd" title="Snapcraft: The LXD snap">the snap version of LXD</a> as well as <a href="https://packages.ubuntu.com/source/bionic/lxd" title="Ubuntu packages: lxd source package">the deb</a></em></li>
  <li><em>use <a href="https://blog.ubuntu.com/2016/12/08/mounting-your-home-directory-in-lxd">a better method</a> of sharing folders (<a href="https://github.com/nottrobin/development.robinwinslow.uk/issues/2">thanks @sparkiegeek</a>)</em></li>
</ul>

<hr />

<p><a href="https://linuxcontainers.org/">Linux Containers (LXC)</a> effectively spin up mini virtual operating systems inside Linux, except that they’re much more light-weight, and therefore much quicker, than true <a href="https://en.wikipedia.org/wiki/Virtual_machine" title="Virtual machines">virtual machines</a>.</p>

<p><a href="https://linuxcontainers.org/lxd/" title="Linux Containers: What's LXD?">LXD</a> is a new system-wide daemon from Canonical’s <a href="https://twitter.com/stgraber">Stéphane Graber</a> which improves performance &amp; security, and also offers an improve interface for the <code class="language-plaintext highlighter-rouge">lxc</code> command.</p>

<p>You may want to skip straight to <a href="#installing-lxd">Installing LXD</a> or <a href="#how-to-use-lxd">How to use LXD</a>.</p>

<h1 id="tldr-summary">tl;dr summary</h1>

<p>Once you’ve <a href="https://linuxcontainers.org/lxd/getting-started-cli/" title="Installing LXD and the command line tool">installed LXD</a>, create a new container and open a bash terminal with:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>lxc launch ubuntu:bionic caged-beaver   <span class="c"># Download 18.04 Bionic Beaver image and start the container</span>
lxc <span class="nb">exec </span>caged-beaver <span class="nt">--</span> bash           <span class="c"># Run and attach to a bash terminal in the container</span>
</code></pre></div></div>

<h1 id="why-are-containers-so-useful">Why are containers so useful?</h1>

<p>As containers are like lighter virtual machines, you can use them for very much the same things, but do them <em>much</em> faster:</p>

<ul>
  <li>Install &amp; run things in a different version of Linux than is installed locally</li>
  <li>Run a software project within a predictable context for development (e.g. many
people currently use <a href="https://www.vagrantup.com/" title="Vagrant homepage">Vagrant</a> for this)</li>
  <li>Test that things still work in a clean install of your operating system</li>
</ul>

<p>Also, as containers are phenomenally faster (they can take less than one second to start) and use much less resources, they also bring with them new possibilities:</p>

<ul>
  <li>Run many containers side-by-side, to test out large networks of interconnected services</li>
  <li>Run each individual process in its own container with encapsulated
dependencies (rather than whole software projects)</li>
</ul>

<h2 id="initialising-lxd">Initialising LXD</h2>

<p>LXD should be available by default in Ubuntu 16.04 Xenial and newer. You can see what version you have with <code class="language-plaintext highlighter-rouge">lxc --version</code> - if it’s v2 or newer, these instructions should work for you.</p>

<p>If you don’t have <code class="language-plaintext highlighter-rouge">lxc</code> v2 or newer, refer to <a href="https://linuxcontainers.org/lxd/getting-started-cli/">the official installation guide</a>.</p>

<p>Now initialise LXD, with a <code class="language-plaintext highlighter-rouge">dir</code> backend and an LXD bridge:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>lxd init
Name of the storage backend to use <span class="o">(</span><span class="nb">dir </span>or zfs<span class="o">)</span>: <span class="nb">dir
</span>Would you like LXD to be available over the network <span class="o">(</span><span class="nb">yes</span>/no<span class="o">)</span>? no
Do you want to configure the LXD bridge <span class="o">(</span><span class="nb">yes</span>/no<span class="o">)</span>? <span class="nb">yes</span>
</code></pre></div></div>

<p>Now the “Package configuration” will open and ask you to configure LXD. If you’re unsure about any of the questions, just select the default option by pressing <code class="language-plaintext highlighter-rouge">&lt;enter&gt;</code>.</p>

<p>Read the <a href="https://linuxcontainers.org/lxd/getting-started-cli/" title="Installing LXD and the command line tool">official installation guide</a>.</p>

<h1 id="how-to-use-lxd">How to use LXD</h1>

<p>When I first drafted this post, the latest version of LXD was <code class="language-plaintext highlighter-rouge">2.0.0</code>. At the time of publishing, it’s now <a href="https://discuss.linuxcontainers.org/t/lxd-3-9-has-been-released/3732"><code class="language-plaintext highlighter-rouge">3.9</code></a> - however I believe all the commands mentioned below still work.</p>

<h2 id="quickly-start-a-container">Quickly start a container</h2>

<p>To download and start a container running <a href="https://wiki.ubuntu.com/BionicBeaver/ReleaseNotes" title="Ubuntu wiki: Bionic Beaver 18.04 release notes">Ubuntu 18.04 Bionic Beaver</a>, simply run:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>lxc launch ubuntu:bionic caged-beaver  <span class="c"># "caged-beaver" could be any name you choose</span>
</code></pre></div></div>

<p>It will take a while the first time as it has to download the OS image, but to create subsequent containers from the same image should only take a matter of seconds.</p>

<p>Once it’s finished, check it’s running:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>lxc list
+--------------+---------+----------------------+----------------+------------+-----------+
|     NAME     |  STATE  |         IPV4         |      IPV6      |    TYPE    | SNAPSHOTS |
+--------------+---------+----------------------+----------------+------------+-----------+
| caged-beaver | RUNNING | 10.94.108.174 <span class="o">(</span>eth0<span class="o">)</span> | a:a:a:a <span class="o">(</span>eth0<span class="o">)</span> | PERSISTENT |           |
+--------------+---------+----------------------+----------------+------------+-----------+
</code></pre></div></div>

<h2 id="running-commands">Running commands</h2>

<p>To run a command in our new container, use the <code class="language-plaintext highlighter-rouge">lxc exec</code> command. The command will run as the <code class="language-plaintext highlighter-rouge">root</code> user, in the <code class="language-plaintext highlighter-rouge">/root</code> directory inside the container.</p>

<p>You can run any command that you would normally run in a Linux system, but the most immediately useful command to run is <code class="language-plaintext highlighter-rouge">bash</code>, which will drop you into a bash shell inside the container:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>lxc <span class="nb">exec </span>caged-beaver <span class="nt">--</span> bash
root@caged-beaver:~# <span class="nb">echo</span> <span class="s2">"hello from inside the container!"</span>
hello from inside the container!
root@caged-beaver:~#
</code></pre></div></div>

<h2 id="networking">Networking</h2>

<p>If you <a href="#initialising-lxd">initialised LXD earlier</a> with a network bridge, your container should already have an IP address which you can connect to directly:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>lxc list caged-beaver <span class="nt">--format</span><span class="o">=</span>json | jq <span class="nt">-r</span> <span class="s1">'.[0]["state"]["network"]["eth0"]["addresses"][0]["address"]'</span>  <span class="c"># Find the IP address</span>
10.95.60.183
<span class="nv">$ </span>ping 10.95.60.183  <span class="c"># Check we can see that IP address</span>
64 bytes from 10.95.60.183: <span class="nv">icmp_seq</span><span class="o">=</span>1 <span class="nv">ttl</span><span class="o">=</span>64 <span class="nb">time</span><span class="o">=</span>0.134 ms
</code></pre></div></div>

<p>You can use this IP address for accessing any servers that you run in your container. If you need to use different network settings, simply run <code class="language-plaintext highlighter-rouge">lxd init</code> again.</p>

<h2 id="sharing-folders">Sharing folders</h2>

<p>You can share folders with your container as “devices”. The syntax is:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>lxc config device add <span class="o">{</span>container-name<span class="o">}</span> <span class="o">{</span>device-name<span class="o">}</span> disk <span class="nb">source</span><span class="o">={</span>full-path-to-folder<span class="o">}</span> <span class="nv">path</span><span class="o">={</span>path-inside-container<span class="o">}</span>
</code></pre></div></div>

<p>So if we want to create a <code class="language-plaintext highlighter-rouge">share</code> directory and share it with the container at <code class="language-plaintext highlighter-rouge">/media/share</code>:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">mkdir </span>share  <span class="c"># Create a new "share" directory</span>
<span class="nb">touch </span>share/hello  <span class="c"># Create a "hello" file inside the directory</span>
lxc config device add caged-beaver shareddir disk <span class="nb">source</span><span class="o">=</span><span class="sb">`</span><span class="nb">pwd</span><span class="sb">`</span>/share <span class="nv">path</span><span class="o">=</span>/media/share  <span class="c"># Share it with the container</span>
</code></pre></div></div>

<p>Now let’s check the device is set up and that we can see it inside the container:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>lxc config device list caged-beaver  <span class="c"># List all devices in the container</span>
shareddir
<span class="nv">$ </span>lxc <span class="nb">exec </span>caged-beaver <span class="nt">--</span> <span class="nb">ls</span> <span class="nt">-l</span> /media/share
total 0
<span class="nt">-rw-rw-r--</span> 1 nobody nogroup 0 May 16 16:55 hello
</code></pre></div></div>

<h3 id="gaining-write-access-to-shared-folders">Gaining write access to shared folders</h3>

<p>You’ll notice that the file inside <code class="language-plaintext highlighter-rouge">/media/share</code> in the container is owned by <code class="language-plaintext highlighter-rouge">nobody:nogroup</code>. This is true of the directory as well, and means that root can’t actually edit or create files inside the shared directory:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>lxc <span class="nb">exec </span>caged-beaver <span class="nt">--</span> <span class="nb">touch</span> /media/share/hello
<span class="nb">touch</span>: cannot <span class="nb">touch</span> <span class="s1">'/media/share/hello'</span>: Permission denied
</code></pre></div></div>

<p>This is because the permissions inside the container are exactly the same as in the host system - as in the directory is still owned by <em>your user</em>. The container runs as an unprivileged user and so doesn’t have access to your user’s things.</p>

<p>To fix this, we can provide LXD access to our user’s ID (probably <code class="language-plaintext highlighter-rouge">1000</code>). First we need to give our system’s <code class="language-plaintext highlighter-rouge">root</code> user permission to act as our user through <a href="http://man7.org/linux/man-pages/man5/subuid.5.html">subuid</a>:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"root:</span><span class="si">$(</span><span class="nb">id</span> <span class="nt">-u</span><span class="si">)</span><span class="s2">:1"</span> | <span class="nb">sudo tee</span> <span class="nt">-a</span> /etc/subuid
root:1000:1
<span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"root:</span><span class="si">$(</span><span class="nb">id</span> <span class="nt">-g</span><span class="si">)</span><span class="s2">:1"</span> | <span class="nb">sudo tee</span> <span class="nt">-a</span> /etc/subgid
root:1000:1
</code></pre></div></div>

<p>We can then map the default <code class="language-plaintext highlighter-rouge">ubuntu</code> user for our new container to the user ID for our system user:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>lxc config <span class="nb">set </span>caged-beaver raw.idmap <span class="s2">"both </span><span class="si">$(</span><span class="nb">id</span> <span class="nt">-u</span><span class="si">)</span><span class="s2"> </span><span class="si">$(</span><span class="nb">id</span> <span class="nt">-g</span><span class="si">)</span><span class="s2">"</span>
<span class="nv">$ </span>lxc restart caged-beaver
</code></pre></div></div>

<p>You should now be able to create and edit files in the shared folder from within the container. The container’s <code class="language-plaintext highlighter-rouge">ubuntu</code> user can create files as your system user, and the container’s <code class="language-plaintext highlighter-rouge">root</code> user can create files under its own UID:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>lxc <span class="nb">exec </span>caged-beaver <span class="nt">--</span> <span class="nb">touch</span> /media/share/created-by-root
<span class="nv">$ </span>lxc <span class="nb">exec </span>caged-beaver <span class="nt">--</span> su ubuntu <span class="nt">-c</span> <span class="s2">"touch /media/share/created-by-ubuntu"</span>

<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-l</span> share/
total 0
<span class="nt">-rw-rw-r--</span> 1 robin robin 0 May 16 16:55 hello
<span class="nt">-rw-r--r--</span> 1 1000000 1000000 0 May  16 17:29 created-by-root
<span class="nt">-rw-r--r--</span> 1 robin robin 0 May  16 17:29 created-by-ubuntu

<span class="nv">$ </span>lxc <span class="nb">exec </span>caged-beaver <span class="nt">--</span> <span class="nb">ls</span> <span class="nt">-l</span> /media/share
total 0
<span class="nt">-rw-rw-r--</span> 1 ubuntu ubuntu 0 May 16 16:55 hello
<span class="nt">-rw-r--r--</span> 1 root root 0 May  16 17:29 created-by-root
<span class="nt">-rw-r--r--</span> 1 ubuntu ubuntu 0 May  16 17:29 created-by-ubuntu
</code></pre></div></div>

<h2 id="privileged-containers">Privileged containers</h2>

<p>We can also make containers “privileged”, which sets the root user inside the container to be the same as the root user on the host system.</p>

<p>This would have been a way to solve the shared folders problem above, but it is unsafe (and in that case unnecessary), as it means that programs inside the container can escape into root on the host system in some circumstances.</p>

<p>First, note that the <code class="language-plaintext highlighter-rouge">rootfs</code> directory in your container is currently owned by an unprivileged user:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-ld</span> /var/lib/lxd/containers/caged-beaver/rootfs  <span class="c"># For the Deb version</span>
drwxr-xr-x 22 165536 165536 4096 May 17 17:18 /var/lib/lxd/containers/caged-beaver/rootfs
<span class="c"># OR</span>
<span class="nv">$ </span><span class="nb">sudo ls</span> <span class="nt">-ld</span> /var/snap/lxd/common/mntns/var/snap/lxd/common/lxd/storage-pools/default/containers/caged-beaver/rootfs  <span class="c"># For the snap version</span>
drwxr-xr-x 22 1000000 1000000 22 Jan 31 15:51 /var/snap/lxd/common/mntns/var/snap/lxd/common/lxd/storage-pools/default/containers/caged-beaver/rootfs
</code></pre></div></div>

<p>To make the container privileged, and then restart it:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>lxc config <span class="nb">set </span>caged-beaver security.privileged <span class="nb">true
</span>lxc restart caged-beaver
</code></pre></div></div>

<p>And note that the <code class="language-plaintext highlighter-rouge">rootfs</code> owner is now <code class="language-plaintext highlighter-rouge">root</code> in the host:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-ld</span> /var/lib/lxd/containers/caged-beaver/rootfs  <span class="c"># For the Deb version</span>
drwxr-xr-x 22 root root 4096 May 17 17:18 /var/lib/lxd/containers/caged-beaver/rootfs
<span class="c"># OR</span>
<span class="nv">$ </span><span class="nb">sudo ls</span> <span class="nt">-ld</span> /var/snap/lxd/common/mntns/var/snap/lxd/common/lxd/storage-pools/default/containers/caged-beaver/rootfs  <span class="c"># For the snap version</span>
drwxr-xr-x 22 root root 22 Feb  5 15:12 /var/snap/lxd/common/mntns/var/snap/lxd/common/lxd/storage-pools/default/containers/caged-beaver/rootfs
</code></pre></div></div>

<p>This means that the root user inside the container can now manipulate files on the host system as the root user.</p>

<p>Read more about <a href="https://www.stgraber.org/2014/01/17/lxc-1-0-unprivileged-containers/" title="LXC 1.0: Unprivileged containers [7/10] - Introduction to unprivileged containers">unprivileged vs privileged containers</a>.</p>

<h2 id="launching-other-images">Launching other images</h2>

<p>In the command we ran earlier:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>lxc launch ubuntu:bionic caged-beaver
</code></pre></div></div>

<p>“ubuntu” is the name of a remote image list and “bionic” is the alias of an image from that list.</p>

<p>To find other images, there are several list commands:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>lxc remote list               <span class="c"># See what other remotes are available</span>
lxc image list ubuntu:        <span class="c"># List all images in the "ubuntu" remote</span>
lxc image <span class="nb">alias </span>list ubuntu:  <span class="c"># List every alias in the "ubuntu" remote</span>
lxc image <span class="nb">alias </span>list images:  <span class="c"># List every alias in the "images" remote</span>
</code></pre></div></div>

<p>From the last command, we can see that there’s an image available in the “images” remote with the alias “alpine/edge/amd64”, so we could choose to launch an alpine container in the same way:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>lxc launch images:alpine/edge/amd64 caged-mountain  <span class="c"># Again "caged-mountain", could be any name you choose</span>
</code></pre></div></div>



  
</article>

<script>
  /**
   * Document outline
   */

  // Get elements
  let article = document.querySelector("article");
  let headings = document.querySelector(".headings");
  let list = headings.querySelector("ol");

  // Populate nav
  article.querySelectorAll("h1, h2").forEach(function (heading) {
    let item = document.createElement("li");
    item.classList.add(heading.tagName.toLowerCase());
    item.innerHTML = `<a href="#${heading.id}">${heading.textContent}</a>`;
    list.appendChild(item);
  });

  function toggleHeadings() {
    // Don't show if there's not space
    if (article.offsetLeft < 180) {
      headings.style.display = "none";
      return;
    }

    // More compact layout
    if (article.offsetLeft < 350) {
      list.style.marginRight = "1.5em";
    } else {
      list.style.marginRight = "6em";
    }

    let articleBounding = article.getBoundingClientRect();
    let rightOffset = document.body.offsetWidth - articleBounding.left;

    headings.style.display = "block";
    headings.style.right = rightOffset + "px";

    if (articleBounding.top > 0) {
      headings.style.top = articleBounding.top + "px";
    } else {
      headings.style.top = 0;
    }
  }

  window.addEventListener('scroll', toggleHeadings);
  window.addEventListener('resize', toggleHeadings);

  toggleHeadings();
</script>

<address class="author">
  By <a href="https://twitter.com/nottrobin">@nottrobin</a>
</address>





<nav class="more-posts">
  <h2>More posts</h2>
  
  <p>
    <a href="/blogging-from-my-phone-with-gitjournal">Blogging from my phone with GitJournal</a><br>
    <time datetime="2022-06-05">5th June 2022</time>
  </p>
  
  
  <p>
    <a href="/avoid-dropped-connections-in-nginx-containers">Avoiding dropped connections in nginx containers with "STOPSIGNAL SIGQUIT"</a><br>
    <time datetime="2019-11-18">18th November 2019</time>
  </p>
  
  
  <p>
    <a href="/how-to-manage-git-history">How to manage your Git history: Tips for keeping your commits tidy</a><br>
    <time datetime="2018-12-11">11th December 2018</time>
  </p>
  
</nav>


  <footer class="see-the-code">
    <a href="https://github.com/nottrobin/robinwinslow.uk">☵ See the code</a>
  </footer>

  <!-- Instant.page -->
  <script>
    let mouseoverTimer; let lastTouchTimestamp; const prefetches = new Set; const prefetchElement = document.createElement("link"); const isSupported = prefetchElement.relList && prefetchElement.relList.supports && prefetchElement.relList.supports("prefetch") && window.IntersectionObserver && "isIntersecting" in IntersectionObserverEntry.prototype; const allowQueryString = "instantAllowQueryString" in document.body.dataset; const allowExternalLinks = "instantAllowExternalLinks" in document.body.dataset; const useWhitelist = "instantWhitelist" in document.body.dataset; const mousedownShortcut = "instantMousedownShortcut" in document.body.dataset; const DELAY_TO_NOT_BE_CONSIDERED_A_TOUCH_INITIATED_ACTION = 1111; let delayOnHover = 65; let useMousedown = false; let useMousedownOnly = false; let useViewport = false; if ("instantIntensity" in document.body.dataset) { const intensity = document.body.dataset.instantIntensity; if (intensity.substr(0, "mousedown".length) == "mousedown") { useMousedown = true; if (intensity == "mousedown-only") { useMousedownOnly = true } } else if (intensity.substr(0, "viewport".length) == "viewport") { if (!(navigator.connection && (navigator.connection.saveData || navigator.connection.effectiveType && navigator.connection.effectiveType.includes("2g")))) { if (intensity == "viewport") { if (document.documentElement.clientWidth * document.documentElement.clientHeight < 45e4) { useViewport = true } } else if (intensity == "viewport-all") { useViewport = true } } } else { const milliseconds = parseInt(intensity); if (!isNaN(milliseconds)) { delayOnHover = milliseconds } } } if (isSupported) { const eventListenersOptions = { capture: true, passive: true }; if (!useMousedownOnly) { document.addEventListener("touchstart", touchstartListener, eventListenersOptions) } if (!useMousedown) { document.addEventListener("mouseover", mouseoverListener, eventListenersOptions) } else if (!mousedownShortcut) { document.addEventListener("mousedown", mousedownListener, eventListenersOptions) } if (mousedownShortcut) { document.addEventListener("mousedown", mousedownShortcutListener, eventListenersOptions) } if (useViewport) { let triggeringFunction; if (window.requestIdleCallback) { triggeringFunction = (callback => { requestIdleCallback(callback, { timeout: 1500 }) }) } else { triggeringFunction = (callback => { callback() }) } triggeringFunction(() => { const intersectionObserver = new IntersectionObserver(entries => { entries.forEach(entry => { if (entry.isIntersecting) { const linkElement = entry.target; intersectionObserver.unobserve(linkElement); preload(linkElement.href) } }) }); document.querySelectorAll("a").forEach(linkElement => { if (isPreloadable(linkElement)) { intersectionObserver.observe(linkElement) } }) }) } } function touchstartListener(event) { lastTouchTimestamp = performance.now(); const linkElement = event.target.closest("a"); if (!isPreloadable(linkElement)) { return } preload(linkElement.href) } function mouseoverListener(event) { if (performance.now() - lastTouchTimestamp < DELAY_TO_NOT_BE_CONSIDERED_A_TOUCH_INITIATED_ACTION) { return } const linkElement = event.target.closest("a"); if (!isPreloadable(linkElement)) { return } linkElement.addEventListener("mouseout", mouseoutListener, { passive: true }); mouseoverTimer = setTimeout(() => { preload(linkElement.href); mouseoverTimer = undefined }, delayOnHover) } function mousedownListener(event) { const linkElement = event.target.closest("a"); if (!isPreloadable(linkElement)) { return } preload(linkElement.href) } function mouseoutListener(event) { if (event.relatedTarget && event.target.closest("a") == event.relatedTarget.closest("a")) { return } if (mouseoverTimer) { clearTimeout(mouseoverTimer); mouseoverTimer = undefined } } function mousedownShortcutListener(event) { if (performance.now() - lastTouchTimestamp < DELAY_TO_NOT_BE_CONSIDERED_A_TOUCH_INITIATED_ACTION) { return } const linkElement = event.target.closest("a"); if (event.which > 1 || event.metaKey || event.ctrlKey) { return } if (!linkElement) { return } linkElement.addEventListener("click", function (event) { if (event.detail == 1337) { return } event.preventDefault() }, { capture: true, passive: false, once: true }); const customEvent = new MouseEvent("click", { view: window, bubbles: true, cancelable: false, detail: 1337 }); linkElement.dispatchEvent(customEvent) } function isPreloadable(linkElement) { if (!linkElement || !linkElement.href) { return } if (useWhitelist && !("instant" in linkElement.dataset)) { return } if (!allowExternalLinks && linkElement.origin != location.origin && !("instant" in linkElement.dataset)) { return } if (!["http:", "https:"].includes(linkElement.protocol)) { return } if (linkElement.protocol == "http:" && location.protocol == "https:") { return } if (!allowQueryString && linkElement.search && !("instant" in linkElement.dataset)) { return } if (linkElement.hash && linkElement.pathname + linkElement.search == location.pathname + location.search) { return } if ("noInstant" in linkElement.dataset) { return } return true } function preload(url) { if (prefetches.has(url)) { return } const prefetcher = document.createElement("link"); prefetcher.rel = "prefetch"; prefetcher.href = url; document.head.appendChild(prefetcher); prefetches.add(url) }
  </script>
</body>

</html>
